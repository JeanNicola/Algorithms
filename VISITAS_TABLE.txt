CREATE TABLE CLICKS (
    CLICK_ID INTEGER,
    USERID VARCHAR2(255),
    CLICK_DATE DATE,
    CONSTRAINT CLICK_PK PRIMARY KEY (CLICK_ID)
)

CREATE TABLE MENUS (
    MENU_ID INTEGER,
    MENU_DEEP VARCHAR2(255),
    MENU_NAME VARCHAR(255),
    CONSTRAINT MENU_PK PRIMARY KEY (MENU_ID)
)

CREATE TABLE CLICKS_MENUS (
    CLICK_ID INTEGER NOT NULL,
    MENU_ID INTEGER NOT NULL,
    CONSTRAINT CLICK_FK FOREIGN KEY (CLICK_ID) REFERENCES CLICKS (CLICK_ID),
    CONSTRAINT MENU_FK FOREIGN KEY (MENU_ID) REFERENCES MENUS (MENU_ID)
)

CREATE OR REPLACE PROCEDURE 
    REGISTER_VISIT (USERID IN VARCHAR, CLICK_DATE IN VARCHAR, CLICK_ID IN INTEGER, MENU_ID IN INTEGER)
    IS BEGIN
        INSERT INTO CLICKS (CLICK_ID , USERID, CLICK_DATE) VALUES (CLICK_ID, USERID, TO_DATE(CLICK_DATE, 'yyyy/mm'));
        INSERT INTO CLICKS_MENUS (CLICK_ID, MENU_ID) VALUES (CLICK_ID, MENU_ID);
        COMMIT;
    END;

BEGIN
    REGISTER_VISIT('NJ118998', '2019/09', 1, 2);
END;

SELECT COUNT(CLICKS.CLICK_ID) AS CLICKS, USERID, MENU_DEEP, CLICK_DATE FROM CLICKS_MENUS 
INNER JOIN CLICKS ON CLICKS_MENUS.CLICK_ID = CLICKS.CLICK_ID
INNER JOIN MENUS ON CLICKS_MENUS.MENU_ID = MENUS.MENU_ID
WHERE CLICK_DATE > (sysdate-330)
GROUP BY CLICK_DATE, USERID, MENU_DEEP;


CREATE SEQUENCE  "CGO"."FLYERS_SEQ"  
MINVALUE 1 MAXVALUE 9999999999999999999999999999 
INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE;

CREATE OR REPLACE TRIGGER "CGO"."FLYERS_TRG" 
BEFORE INSERT ON CGO.EVENTOS_FLYERS
FOR EACH ROW 
BEGIN
  <<COLUMN_SEQUENCES>>
  BEGIN
    IF INSERTING AND :NEW.ID IS NULL THEN
      SELECT FLYERS_SEQ.NEXTVAL INTO :NEW.ID FROM SYS.DUAL;
    END IF;
  END COLUMN_SEQUENCES;
END;
/
ALTER TRIGGER "CGO"."FLYERS_TRG" ENABLE;



